---
title: "Midterm"
author: "Jack Chen, Emmanuel"
date: "2024-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

```{r library, include=FALSE}
library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(dplyr)
library(RColorBrewer)
#library(geojsonio)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette5 = c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
```

# Data

```{r data, include=FALSE}
studentdata = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/studentData.geo.json") %>%
   st_transform("EPSG:6565")
hospital = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/DOH_Hospitals202311.geojson") %>% 
  st_transform("EPSG:6565")
farmermarket = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Farmers_Markets.geojson") %>%
  st_transform("EPSG:6565")
parks = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Parks.geojson") %>%
  st_transform("EPSG:6565")
schools = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Schools.geojson") %>%
  st_transform("EPSG:6565")
bikestations = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/bikestation.geojson") %>%
  st_transform("EPSG:6565")
crime = read.csv("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/incidents_part1_part2.csv")
```

|              Variable              | Variable Name in Dataset |
|:----------------------------------:|:------------------------:|
|    **Internal Characteristics**    |                          |
|            Age of House            |           age            |
|       Total Number of Rooms        |         totRooms         |
|         Includes Basement?         |       incBasements       |
|           Includes A/C?            |          incAC           |
|        Quality of building         |     buildingQuality      |
|          Includes Garage?          |        incGarage         |
|        Stories in Building         |         Stories           |
|                Area                |         maxArea          |
|        Observable Sceneries        |         scenery          |
|        **Nearby Amenities**        |                          |
|         Surrounding Crimes         |                          |
|       Distance to Hospitals        |                          |
| Distance to Nearest Farmers Market |                          |
|     Nearby Private High School     |                          |

```{r wrangle data, includ=FALSE}
farmersmarket.f = farmermarket %>%
  select(globalid, name, operator, zip, objectid, geometry)
hospital.f = hospital %>%
  select(OBJECTID, GEOCODING_, LONGITUDE, COUNTY, LATITUDE, ZIP_CODE, geometry)
parks.f = parks %>%
  select(OBJECTID, PARK_NAME, DPP_ASSET_ID, geometry)
schools.f = schools %>%
  filter(TYPE_SPECIFIC != "ARCHDIOCESE") %>% # Not everyone is religious, so we remove this option
  select(OBJECTID, AUN, SCHOOL_NAME, ZIP_CODE, geometry)
bikestations.f = bikestations %>%
  select(id, name, addressStreet, addressZipCode, latitude, longitude, coordinates, geometry)

studentdata.f = studentdata %>%
  dplyr::select(objectid, basements, geometry, census_tract, category_code, central_air, fireplaces, fuel, garage_type, interior_condition, location, number_of_bedrooms, number_of_bathrooms, number_stories, number_of_rooms, quality_grade, state_code, street_code, sale_price, sale_date, sale_year, total_livable_area, type_heater, total_area, unfinished, unit, view_type, year_built, zip_code, toPredict) %>%
  mutate(incBasements = case_when(
          !is.na(basements) & basements != 0~ "Y", TRUE~ "N"),
        incAC = case_when(
          central_air %in% c("1", "Y") ~ "Y",
          TRUE~ "N"),
        incGarage = case_when(
          garage_type == 0 | is.na(garage_type)  ~ "N",
          TRUE~ "Y"),
        age = 2023 - year_built,
        interiorQuality = case_when(
          interior_condition >= 2 & interior_condition <= 4 ~ "GOOD",
          interior_condition > 4 ~ "BAD",
          TRUE ~ "NA"),
        totRooms = case_when(
           is.na(number_of_bedrooms) & !is.na(number_of_bedrooms) ~ number_of_bathrooms,
           is.na(number_of_bathrooms) & !is.na(number_of_bedrooms) ~ number_of_bedrooms,
           is.na(number_of_bathrooms) & is.na(number_of_bedrooms) ~ 0,
           TRUE ~ number_of_bedrooms + number_of_bathrooms),
        stories = case_when(
           number_stories == 1  ~ "SINGLE",
           TRUE~ "MULTIPLE"),
        maxArea = case_when(
           total_livable_area > total_area ~ total_livable_area,
           TRUE ~ total_area),
        incHeater = case_when(
           type_heater == 0 | is.na(type_heater)  ~ "N",
           TRUE~ "Y"),
        scenery = case_when(
           view_type == "I" | view_type == "0" | is.na(view_type)   ~ "STANDARD",
           view_type == "A" | view_type == "B" | view_type == "C" ~ "GOOD",
           TRUE~ "BELOW AVERAGE"),
        buildingQuality = case_when(
           quality_grade %in% c("3", "4", "5", "6", "A", "A+", "A-", "B", "B+","B-","S","S+","X-")  ~ "Good",
           TRUE~ "Bad")) %>%
  dplyr::select(-basements, -central_air, -garage_type, -interior_condition, -number_stories, -type_heater, -view_type, -quality_grade) %>%
  filter(age >= 0)


fm.idx = st_nearest_feature(studentdata.f, farmersmarket.f)
hospital.idx = st_nearest_feature(studentdata.f, hospital.f)
parks.idx = st_nearest_feature(studentdata.f, parks.f)

# Calculate distances to the nearest features using the indices
studentdata.f = studentdata.f %>%
  mutate(
    farmersmarket.d.ft = as.numeric(
      st_distance(geometry, st_geometry(farmersmarket.f)[fm.idx], by_element = TRUE)),
    hospital.d.ft = as.numeric(
      st_distance(geometry, st_geometry(hospital.f)[hospital.idx], by_element = TRUE)),
    parks.d.ft = as.numeric(
      st_distance(geometry, st_geometry(parks.f)[parks.idx], by_element = TRUE)),
    schools.c = lengths(
      st_intersects(studentdata.f, st_buffer(schools.f, units::set_units(1.5, mile)))),
    bikestations.c = lengths(
      st_intersects(studentdata.f, st_buffer(bikestations.f, units::set_units(0.5, mile))))
  )

# group_by(schools, TYPE_SPECIFIC) %>%
#   summarize(count = n()) %>%
#   arrange(-count)

modellingdata = studentdata.f %>%
  filter(toPredict == 'MODELLING') 

challengedata = studentdata.f %>%
  filter(toPredict == 'CHALLENGE')
```

```{r split data}
set.seed(1111) 
total_features = nrow(modellingdata)
split_index = sample(1:total_features, size = total_features * 0.6)


trainingmodel = modellingdata[split_index, ] 
testingmodel = modellingdata[-split_index, ] %>%
  select(-sale_price)
```

```{r decide moran/k, include=FALSE}
moran_results = data.frame(K = integer(),
                            Moran_I = numeric(),
                            Expectation = numeric(),
                            Variance = numeric(),
                            Standard_Deviate = numeric())
for (k in 5:20) {
  nb_k = knn2nb(knearneigh(st_coordinates(studentdata.f), k=k))
  wt_k = nb2listw(nb_k)
  moran_test = moran.test(studentdata.f$sale_price, wt_k)
  moran_I = moran_test$estimate[1]
  expectation = moran_test$estimate[2]
  variance = moran_test$estimate[3]
  standard_deviate = moran_test$statistic
  moran_results = rbind(moran_results, data.frame(K = k,
                                                   Moran_I = moran_I,
                                                   Expectation = expectation,
                                                   Variance = variance,
                                                   Standard_Deviate = standard_deviate))
}
print(moran_results)
 # K=7
```

```{r data summary corrmatrix, }
corrvars <- 
  studentdata.f %>% 
  dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft)

corrvar <- select_if(st_drop_geometry(corrvars), is.numeric) %>% 
  na.omit()

ggcorrplot(
  round(cor(corrvar), 1), 
  p.mat = cor_pmat(corrvar),
  colors = c("#30003a", "white", "#063615"),
  type="lower",
  insig = "blank") +  
  labs(title = "Correlation Matrix - All Numerical Variables") +
  guides(fill = guide_legend(title = "Correlation")) +
  theme(plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x = element_text(angle = 25, size = 6),
        axis.text.y = element_text(size=6), 
        axis.title = element_text(size=8),
        axis.title.y = element_blank())
```

```{r variable summary dependent map}
philly = st_read("https://opendata.arcgis.com/datasets/0960ea0f38f44146bb562f2b212075aa_0.geojson") %>%
  st_transform('EPSG:6565') 

ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = studentdata.f, size=0.75,aes(colour = q5(sale_price))) +
    scale_color_manual(values = c('#ffffb2', '#c2e699', '#78c679', '#31a354', '#006837'),
                    name = "Houses Sales Price",
                    na.value = 'transparent',
                    labels = c('< 250k', '250k-500k', '500k-750k', '750k-1mil', '1mil <')) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Distribution of Sale Price in Philadelphia") 
```