---
title: "Midterm"
author: "Jack Chen, Emmanuel Jiang"
date: "2024-10-04"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The purpose of this project is to create a predictive model that leverages comprehensive datasets from various sources, including Philadelphiaâ€™s Open Data portal and Tigris, to enhance the accuracy of home price predictions. By focusing on local factors and features that impact property values, the team aims to deliver insights that can significantly inform Zillow's pricing strategies.

There are particular challenges associated with this exercise. First, the intricacies of the Philadelphia housing market require a nuanced understanding of various local variables, such as neighborhood characteristics, amenities, and spatial structures. Second, the analysis is limited to using Ordinary Least Squares (OLS) regression for the modeling approach, which, while foundational, may not capture complex nonlinear relationships as effectively as other algorithms. Thus, the modeling strategy involves meticulous feature selection and engineering to optimize the predictive power of the OLS regression model.

This report will detail the data gathering methods, present the summary statistics, and explore the correlations among key variables. Additionally, the findings will be visualized through various maps and scatterplots to provide a clear narrative that supports the analytical insights. By the conclusion of this project, the aim is not only to generate accurate predictions but also to foster a deeper understanding of the factors influencing housing prices in Philadelphia, ultimately guiding Zillow in enhancing its market predictions.

```{r library, include=FALSE}
options(scipen=999)
options(tigris_class = "sf")
options(digits = 3)

library(tidyverse)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)
library(dplyr)
library(RColorBrewer)
library(classInt)
library(kableExtra)
library(tidycensus)
library(ggplot2)
library(reshape2)
library(ggtext)
library(glue)
#library(geojsonio)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

get_breaks <- function(sf_object, column_name, num_breaks, breaktype) {
  if (!(column_name %in% colnames(sf_object))) {
    stop("The specified column does not exist in the sf object.")
  }
  column_values <- sf_object[[column_name]]
  if (!is.numeric(column_values)) {
    stop("The specified column is not numeric.")
  }
  breaks <- classInt::classIntervals(column_values, n = num_breaks, style = breaktype)$brks
  print(breaks)
}
```

# Data

The major dataset involved in this project is the Philadelphia housing price data, which serves as the dependent variable to predict. Independent variables include local amenities such as hospitals, schools, parks, and farmers' markets, all of which are crucial to understanding the factors that influence housing prices.

```{r data, include=FALSE}
studentdata = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/studentData.geo.json") %>%
   st_transform("EPSG:6565")
hospital = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/DOH_Hospitals202311.geojson") %>% 
  st_transform("EPSG:6565")
farmermarket = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Farmers_Markets.geojson") %>%
  st_transform("EPSG:6565")
parks = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Parks.geojson") %>%
  st_transform("EPSG:6565")
schools = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Schools.geojson") %>%
  st_transform("EPSG:6565")
bikestations = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/bikestation.geojson") %>%
  st_transform("EPSG:6565")
crime = read.csv("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/incidents_part1_part2.csv")
```

|              Variable              | Variable Name in Dataset |
|:----------------------------------:|:------------------------:|
|    **Internal Characteristics**    |                          |
|            Age of House            |           age            |
|       Total Number of Rooms        |         totRooms         |
|         Includes Basement?         |       incBasements       |
|           Includes A/C?            |          incAC           |
|        Quality of building         |     buildingQuality      |
|          Includes Garage?          |        incGarage         |
|        Stories in Building         |         Stories          |
|                Area                |         maxArea          |
|        **Nearby Amenities**        |                          |
|     Distance to Nearest Hospital   |      hospitals.d.ft      |
| Distance to Nearest Farmers Market |    farmersmarket.d.ft    |
| Distance to Nearest Park           |        parks.d.ft        |
|           Nearby Schools           |        schools.c         |
|         Nearby Bike Stations       |     bikestations.c       |

## Data Wrangling

In this section, the focus is on preparing and transforming the raw datasets to make them suitable for analysis. The objective is to extract relevant features, clean the data, and calculate distances to key amenities, which will serve as important predictors in the housing price prediction model.

The first step involves loading each dataset corresponding to various amenities, including farmers' markets, hospitals, parks, schools, and bike stations. For each dataset, the select() function is used to retain only the necessary variables. For instance, when selecting data for farmers' markets, the team keeps identifiers and geometric information. Similarly, the hospital dataset is filtered to retain essential hospital identifiers and geographic data, while the parks dataset selects park identifiers and their geometry for further spatial analysis.

For the schools dataset, the team filters out institutions affiliated with religious organizations, ensuring a focus on public and charter schools. This is particularly important, as it allows for a broader analysis of schools that serve a diverse population. The bike station dataset is also processed to retain necessary identifiers and spatial information, making it suitable for subsequent analyses.

```{r wrangle data, warning = FALSE, message = FALSE}
farmersmarket.f = farmermarket %>%
  select(globalid, name, operator, zip, objectid, geometry)
hospital.f = hospital %>%
  select(OBJECTID, GEOCODING_, LONGITUDE, COUNTY, LATITUDE, ZIP_CODE, geometry)
parks.f = parks %>%
  select(OBJECTID, PARK_NAME, DPP_ASSET_ID, geometry)
schools.f = schools %>%
  filter(TYPE_SPECIFIC != "ARCHDIOCESE") %>% # Not everyone is religious, so we remove this option
  select(OBJECTID, AUN, SCHOOL_NAME, ZIP_CODE, geometry)
bikestations.f = bikestations %>%
  select(id, name, addressStreet, addressZipCode, latitude, longitude, coordinates, geometry)

studentdata.f = studentdata %>%
  dplyr::select(objectid, basements, geometry, census_tract, category_code, central_air, fireplaces, fuel, garage_type, interior_condition, location, number_of_bedrooms, number_of_bathrooms, number_stories, number_of_rooms, parcel_number, quality_grade, state_code, street_code, sale_price, sale_date, sale_year, total_livable_area, type_heater, total_area, unfinished, unit, view_type, year_built, zip_code, toPredict) %>%
  mutate(incBasements = case_when(
          !is.na(basements) & basements != 0 ~ "Y", TRUE~ "N"),
        incAC = case_when(
          central_air %in% c("1", "Y") ~ "Y",
          TRUE~ "N"),
        incGarage = case_when(
          garage_type == 0 | is.na(garage_type)  ~ "N",
          TRUE~ "Y"),
        age = 2023 - year_built,
        interiorQuality = case_when(
          interior_condition >= 2 & interior_condition <= 4 ~ "GOOD",
          interior_condition > 4 ~ "BAD",
          TRUE ~ "NA"),
        totRooms = case_when(
           is.na(number_of_bedrooms) & !is.na(number_of_bedrooms) ~ number_of_bathrooms,
           is.na(number_of_bathrooms) & !is.na(number_of_bedrooms) ~ number_of_bedrooms,
           is.na(number_of_bathrooms) & is.na(number_of_bedrooms) ~ 0,
           TRUE ~ number_of_bedrooms + number_of_bathrooms),
        stories = case_when(
           number_stories == 1  ~ "SINGLE",
           TRUE~ "MULTIPLE"),
        maxArea = case_when(
          is.na(total_livable_area) & !is.na(total_area) ~ total_area,
          !is.na(total_livable_area) & is.na(total_area) ~ total_livable_area,
          is.na(total_livable_area) & is.na(total_area) ~ 0,
          total_livable_area > total_area ~ total_livable_area,
          TRUE ~ total_area),
        incHeater = case_when(
           type_heater == 0 | is.na(type_heater)  ~ "N",
           TRUE~ "Y"),
        buildingQuality = case_when(
           quality_grade %in% c("3", "4", "5", "6", "A", "A+", "A-", "B", "B+","B-","S","S+","X-")  ~ "Good",
           TRUE~ "Bad")) %>%
  mutate(logMaxArea = log(maxArea)) %>%
  dplyr::select(-basements, -central_air, -garage_type, -interior_condition, -number_stories, -type_heater, -view_type, -quality_grade) %>%
  filter(age >= 0) %>%
  filter(age < 500) %>%
  filter(sale_price <= 1000000) %>%
  filter(sale_price > 0)


# Calculate distances to the nearest features using the indices
studentdata.f = studentdata.f %>%
  mutate(
    farmersmarket.d.ft = as.numeric(
      nn_function(st_coordinates(studentdata.f), st_coordinates(farmersmarket.f), 1)),
    hospital.d.ft = as.numeric(
      nn_function(st_coordinates(studentdata.f), st_coordinates(hospital.f), 1)),
    parks.d.ft = as.numeric(
      nn_function(st_coordinates(studentdata.f), st_coordinates(parks.f), 1)),
    schools.c = lengths(
      st_intersects(studentdata.f, st_buffer(schools.f, units::set_units(1.5, mile)))),
    bikestations.c = lengths(
      st_intersects(studentdata.f, st_buffer(bikestations.f, units::set_units(0.5, mile))))
  )

# group_by(schools, TYPE_SPECIFIC) %>%
#   summarize(count = n()) %>%
#   arrange(-count)
```

## Data splitting

The process of splitting the dataset into training and testing subsets is a fundamental step in developing a predictive model. This division serves multiple purposes, primarily aimed at enhancing the model's reliability and generalizability. By segregating the data, the team ensures that the model is trained on one portion while being evaluated on a completely separate portion, which is crucial for assessing the modelâ€™s performance on unseen data.

[Training the model on a subset of ,he data allows it to learn the underlying patterns and relationships between the input features and the target variableâ€”in this case, housing prices. This training set is used to optimize the modelâ€™s parameters and improve its predictive capabilities. By exposing the model to a diverse range of examples during training, the team can increase the likelihood that it will perform well when applied to new, unseen data.] might not need

On a side note, setting a random seed in the data splitting process enhances reproducibility. By fixing the random seed, the team ensures that the same rows are selected for the training and testing sets each time the code is executed. This consistency is vital for validating results and conducting further analyses or iterations of the model, as it allows other researchers or analysts to replicate the findings under the same conditions.

```{r splitting general data, warning = FALSE, message = FALSE}
modellingdata = studentdata.f %>%
  filter(toPredict == 'MODELLING') 


challengedata = studentdata.f %>%
  filter(toPredict == 'CHALLENGE')

set.seed(1111) 
total_features = nrow(modellingdata)
split_index = sample(1:total_features, size = total_features * 0.6)


trainingmodel = modellingdata[split_index, ] 
testingmodel = modellingdata[-split_index, ] %>%
  select(-sale_price)
```

```{r decide moran/k, include=FALSE, eval=FALSE}
moran_results = data.frame(K = integer(),
                            Moran_I = numeric(),
                            Expectation = numeric(),
                            Variance = numeric(),
                            Standard_Deviate = numeric())
for (k in 5:20) {
  nb_k = knn2nb(knearneigh(st_coordinates(studentdata.f), k=k))
  wt_k = nb2listw(nb_k)
  moran_test = moran.test(studentdata.f$sale_price, wt_k)
  moran_I = moran_test$estimate[1]
  expectation = moran_test$estimate[2]
  variance = moran_test$estimate[3]
  standard_deviate = moran_test$statistic
  moran_results = rbind(moran_results, data.frame(K = k,
                                                   Moran_I = moran_I,
                                                   Expectation = expectation,
                                                   Variance = variance,
                                                   Standard_Deviate = standard_deviate))
}
print(moran_results)
 # K=7
```

## Correlation Matrix of Continuous Variables

The correlation matrix presented illustrates the relationships between various continuous variables related to housing prices in Philadelphia. These variables include sale price, which represents the price at which houses are sold; age, calculated as the difference between the current year and the year built; total rooms (totRooms), indicating the total number of rooms in the house, including bedrooms and bathrooms; and max area (maxArea), which compares the total livable space and total area of the house. Additionally, the matrix displays the distance to farmers markets (farmersmarket.d.ft), the distance to hospitals (hospital.d.ft), the number of schools nearby (schools.c), and the distance to bike stations (bikestations.c).

The correlation coefficients in the matrix range from -1 to 1, where positive values indicate a direct relationship between variables and negative values indicate an inverse relationship. A coefficient close to 1 implies a strong positive correlation, while a coefficient close to -1 indicates a strong negative correlation. This structure provides a clear overview of how different features relate to one another and to the sale price.

```{r data summary corrmatrix, warning = FALSE, message = FALSE}
corrvars = studentdata.f %>% 
  dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft) %>%
  st_drop_geometry() %>%
  select_if(is.numeric) %>% 
  na.omit()

ggcorrplot(
  round(cor(corrvars), 1), 
  p.mat = cor_pmat(corrvars),
  colors = c("#30003a", "white", "#063615"),
  type="lower",
  insig = "blank") +  
  labs(title = "Correlation Matrix - All Numerical Variables") +
  guides(fill = guide_legend(title = "Correlation")) +
  theme(plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x = element_text(angle = 25, size = 6),
        axis.text.y = element_text(size=6), 
        axis.title = element_text(size=8),
        axis.title.y = element_blank())
```

Upon examining the correlation matrix, several key relationships stand out. The correlation between sale price and max area appears to be notably positive, suggesting that larger houses tend to command higher prices. This aligns with the general expectation that more space translates to increased value, making it an important feature for predictive modeling.

In contrast, the variable age shows a negative correlation with sale price, indicating that older homes may be priced lower compared to newer constructions. This relationship could be influenced by various factors, including the condition of the property and the desirability of newer builds in the market.

Additionally, the correlation between the total number of rooms and sale price is expectedly positive. A higher number of rooms generally correlates with larger homes, which are typically more appealing to families, further driving up sale prices.

Interestingly, the distances to various amenitiesâ€”such as farmers' markets, hospitals, and bike stationsâ€”do not exhibit strong correlations with sale prices. This could imply that while these factors are important in assessing neighborhood desirability, they may not directly influence pricing in the same manner as the physical attributes of the homes themselves.

```{r quantile values, include=FALSE, warning = FALSE, message = FALSE}
get_breaks(studentdata.f, 'sale_price', 4, 'quantile')
get_breaks(studentdata.f, 'maxArea', 4, 'quantile')
get_breaks(studentdata.f, 'age', 4, 'quantile')
get_breaks(studentdata.f, 'farmersmarket.d.ft', 4, 'quantile')
```

[The outputs from the quantile break calculations offer valuable insights into the distribution of key variables affecting housing prices in Philadelphia. The first output shows the quantile breaks for the sale price, with values indicating the distribution of home prices from 0 to 5,990,000, revealing how prices are categorized into intervals. However, a warning about missing values in this variable highlights the potential for incomplete analysis, as these entries were excluded from the calculations. The max area breaks categorize homes based on size, from a minimum of 1 square foot to a maximum of 226,512 square feet, which helps in understanding the relationship between property size and sale prices. Additionally, the age breaks illustrate how homes are distributed by age, with the oldest properties reaching 273 years, indicating trends related to market value over time. Lastly, the distance to farmers markets breaks show the proximity of homes to this amenity, ranging from 78.09 feet to 30,529.72 feet, allowing for an assessment of how access to local resources influences housing prices.] (can)

## Dependent variable 

The map below visually represents the distribution of house sale prices across different neighborhoods in Philadelphia, utilizing a color gradient to indicate price ranges. The colors transition from light yellow for lower-priced homes to darker shades of green for higher-priced properties. Specifically, the price categories are defined as follows: homes priced at less than \$137,000 are represented by the lightest yellow shade; those in the range of \$137,000 to \$228,000 are indicated by a lighter green; homes priced between \$228,000 and \$330,000 are shown with a medium green; properties priced from \$330,000 to \$5,990,000 are depicted with a darker green; and homes exceeding \$5,990,000 are represented by the darkest green shade. This color coding facilitates quick visual assessments of the housing market, allowing viewers to easily identify areas with lower or higher property values.

The results illustrated in the map highlight significant spatial variations in housing prices throughout Philadelphia. Areas marked in light yellow indicate regions where homes are priced below \$137,000, which may represent more affordable housing options or potentially underdeveloped neighborhoods. In contrast, the darker green areas, particularly those that exceed \$5,990,000, suggest the presence of high-value properties, likely located in more affluent neighborhoods with desirable amenities, schools, or proximity to city centers.

```{r variable summary dependent map, warning = FALSE, message = FALSE, results='hide'}
philly = st_read("https://raw.githubusercontent.com/blackmad/neighborhoods/refs/heads/master/philadelphia.geojson") %>%
  st_transform('EPSG:6565')

#print(q5(studentdata.f$sale_price))

ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = studentdata.f, size=0.75,aes(colour = q5(sale_price))) +
    scale_color_manual(values = c('#ffffb2', '#c2e699', '#78c679', '#31a354', '#006837'),
                    name = "Houses Sales Price",
                    na.value = 'transparent',
                    labels = c('< $137000', '$137000-$228000', '$228000-$330000', '$330000-$5990000', '$5990000 <')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Sale Price of Houses in Philadelphia") 
```

The correlation plot visually depicts the relationship between sale price and various continuous variables relevant to the housing market in Philadelphia. Each scatterplot within the grid represents a different variable, including age, number of bike stations nearby (bikestations.c), distance to farmers' markets (farmersmarket.d.ft), distance to hospitals (hospital.d.ft), maximum area of the house (maxArea), distance to parks (parks.d.ft), number of nearby schools (schools.c), and total rooms (totRooms). The horizontal axis of each plot displays the variable value, while the vertical axis represents the corresponding sale price.

The scatterplots illustrate the distribution of data points, with black dots representing individual observations. Each plot includes an orange trend line that indicates the overall direction of the relationship between the variable and sale price. This visual representation allows viewers to quickly assess whether a positive or negative correlation exists between the sale price and each variable.

The findings from the correlation plot reveal several noteworthy relationships. For instance, the scatterplot for max area shows a clear positive correlation with sale price, as indicated by the upward slope of the trend line. This suggests that larger homes tend to sell for higher prices, aligning with general expectations in real estate where property size is a significant factor in determining value.

In contrast, the scatterplots for age, bikestations.c, farmersmarket.d.ft, hospital.d.ft, parks.d.ft, and schools.c show little to no correlation with sale price, as evidenced by the horizontal trend lines. This indicates that, despite the proximity to amenities like bike stations and hospitals, there is no significant impact on the housing prices. This may suggest that factors such as the condition and features of the homes themselves outweigh the influence of these nearby amenities on property values.

The plot for totRooms also demonstrates a positive correlation with sale price, indicating that homes with more rooms are generally priced higher. This finding supports the idea that larger living spaces are more desirable in the housing market.

```{r Correlation scatter plots, warning = FALSE, message = FALSE}
scattervars = studentdata.f %>% 
  dplyr::select(sale_price, age, totRooms, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft) %>%
  st_drop_geometry() %>%
  gather(key = "variable", value = "value", -sale_price)

ggplot(scattervars, aes(x = value, y = sale_price)) +
  geom_point(alpha = 0.6) +  
  facet_wrap(~variable, scales = "free_x") +  
  geom_smooth(method = "lm", se=F, colour = "#FA7800") +
  labs(
    title = "Correlation Between Sale Price and Other Variables",
    x = "Variable Value",
    y = "Sale Price"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(size = 10)  # Adjust facet label size
  )
```

## Spatial distribution of factors

The spatial analysis of house areas across Philadelphia reveals significant patterns in housing size distribution throughout the city. The data categorizes houses into five distinct area ranges, illustrating that the smallest homes, measuring less than 1114 square feet, are predominantly concentrated in the central and southern regions, suggesting these areas may attract smaller households seeking affordability. In contrast, properties ranging from 1114 to 1422 square feet are scattered throughout the city, indicating a transitional market appealing to families looking for modestly sized homes. Mid-sized homes, between 1422 and 2000 square feet, exhibit a more widespread distribution, reflecting a diverse demographic profile that attracts families and professionals. Larger properties, ranging from 2000 to 226512 square feet, are primarily located in the northern and western parts of Philadelphia, highlighting a socio-economic divide where affluent residents tend to reside. The sparse presence of the largest homes, exceeding 226512 square feet, reinforces the rarity of such expansive properties.

```{r area of house map, warning = FALSE, message = FALSE}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(maxArea))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Area (ft^2)",
                    na.value = 'transparent',
                    labels = c('< 1114', '1114-1422', '1422-2000', '2000-226512', '226512 <')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Area of Houses in Philadelphia") 
```

The spatial analysis of the age of houses in Philadelphia, as illustrated by the accompanying map, reveals important patterns regarding the distribution of residential structures throughout the city. The data categorizes houses into five distinct age ranges, with the legend indicating the years of construction: homes built in the last 73 years are represented in light purple, those constructed between 73 to 98 years ago in light blue, between 98 to 103 years in medium blue, 103 to 273 years in dark blue, and properties older than 273 years in dark green. The map demonstrates that the most recent homes, built within the last 73 years, are concentrated primarily in the northern and eastern parts of Philadelphia. This suggests ongoing urban development and possibly a trend toward newer housing in these areas. Conversely, homes that are older than 273 years are sparse and primarily found in certain neighborhoods, indicating that these areas may retain historical significance or are subject to preservation efforts. The map further reveals that many homes, aged between 98 to 103 years, are located in the central parts of the city, potentially reflecting the urban development patterns characteristic of earlier eras. The presence of properties in the 73 to 98-year range scattered throughout the city highlights a transitional phase in the housing stock.

```{r age map, warning = FALSE, message = FALSE}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(age))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Age of House (Yr)",
                    na.value = 'transparent',
                    labels = c('<73', '73-98', '98-103', '103-273', '273+')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Age of Houses in Philadelphia") 
```

The spatial analysis of houses in relation to their distance from the nearest farmers' market in Philadelphia provides valuable insights into accessibility and neighborhood dynamics. The map categorizes houses into five distance ranges, indicating how far residents are from fresh produce and local goods. The light purple shade represents homes located between 78 and 2553 feet from a farmers' market, suggesting a high level of accessibility to fresh food options in these areas. In contrast, the darker shades of blue and green indicate increasing distances, with properties located more than 30,530 feet away, which are less likely to benefit from immediate access to farmers' markets. Notably, areas with the shortest distances to farmers' markets are concentrated in the central parts of Philadelphia, reflecting urban planning efforts to provide essential services within walking distance. This concentration may foster community engagement and encourage healthier lifestyle choices among residents. Conversely, neighborhoods further from farmers' markets may indicate food deserts, where residents face challenges in accessing fresh produce, potentially impacting their health and well-being.

```{r farmers market map, warning = FALSE, message = FALSE}
ggplot()+
    geom_sf(data=philly, fill='transparent',color='black', linewidth = 0.1) +
    geom_sf(data = filter(studentdata.f, maxArea != 'NA'), size=0.75, aes(colour = q5(farmersmarket.d.ft))) +
    scale_color_manual(values = c('#f6eff7','#bdc9e1','#67a9cf','#1c9099','#016c59'),
                    name = "Distance to Nearest Farmers Market (ft)",
                    na.value = 'transparent',
                    labels = c('78-2553', '2553-4565', '4565-7116', '7116-30530', '30530+')
                    ) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title = element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        legend.background = element_rect(fill="grey90")
        ) +
  labs(title = "Houses and Their Distance to Nearest Farmers Market in Philadelphia") 
```

# Modelling Non Spatial Census Data

## Regression model

The intial regression model presented in Table 1 provide valuable insights into the factors influencing housing prices, as determined by the linear regression analysis. The intercept of the model is estimated at approximately \$290,342, indicating the expected sale price of a house when all predictors are set to zero. This serves as a reference point for interpreting the effects of the other variables included in the model.

The age of a house negatively impacts its price, with each additional year resulting in a decrease of about \$428 in sale price. This statistically significant relationship suggests that older homes may require more maintenance or may have outdated features, leading to lower market values. Conversely, the total number of rooms in a house is positively associated with its sale price, increasing by approximately \$16,794 for each additional room. This finding underscores the value of larger homes in the housing market.

In terms of specific amenities, the presence of air conditioning significantly boosts a homeâ€™s value, with an increase of around \$85,192. Similarly, homes classified as having "good" building quality command an additional price of approximately \$116,483, reflecting the high demand for well-constructed properties. However, the inclusion of a basement is associated with a decrease in price of about \$25,035, which may suggest that basements in certain neighborhoods do not add value, possibly due to concerns related to flooding or maintenance issues.

Additionally, the distance to the nearest farmers' market shows a negative relationship with housing prices; specifically, for each foot away from the market, the sale price decreases by approximately \$1.05. This finding emphasizes that proximity to fresh food sources is an important characteristic for homebuyers. The number of schools per acre also negatively impacts prices, with each additional school leading to a decrease of about \$3,813, potentially reflecting concerns about overcrowding or decreased neighborhood appeal.

Distance to hospitals is another critical factor; each foot further from a hospital corresponds to a decrease in sale price of approximately \$3.28, indicating that accessibility to healthcare facilities is a significant consideration for potential buyers. Conversely, the proximity to bike stations has a positive association with home prices, with each additional station increasing the price by around \$31,710, reflecting a growing trend towards active transportation and convenience.

Lastly, the distance to parks shows a positive relationship as well, where each additional foot away from a park leads to an increase in home price of approximately \$5.85. This suggests that access to green spaces is an important factor in the desirability of residential properties.

```{r training regression non spatial, warning = FALSE, message = FALSE}
trReg <- lm(sale_price ~ ., data = trainingmodel %>% st_drop_geometry() %>% 
                                 dplyr::select(sale_price, age, totRooms, incBasements, incAC, buildingQuality, incGarage, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft))

trRegSummary <- summary(trReg)
coTable <- as.data.frame(trRegSummary$coefficients)

coTable$significance <- ifelse(coTable$`Pr(>|t|)` < 0.001, '***',
                                         ifelse(coTable$`Pr(>|t|)` < 0.01, '**',
                                                ifelse(coTable$`Pr(>|t|)` < 0.05, '*',
                                                       ifelse(coTable$`Pr(>|t|)` < 0.1, '.', ''))))

coTable$p_value <- paste0(round(coTable$`Pr(>|t|)`, digits = 3), coTable$significance)

coTable %>%
  select(-significance, -`Pr(>|t|)`) %>% 
  kable(align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 1")
```

Using the baseline model, the sale price by dividing the data into training and testing sets. It is then computed the Mean Absolute Error (MAE) and Mean Absolute Percentage Error (MAPE) for the testing set. Currently, the MAE is 81305, while the MAPE stands at 35.5%.

```{r regression of non spatial training model, warning = FALSE, message = FALSE}
trainingReg <- lm(sale_price ~ ., data = trainingmodel %>% 
                    st_drop_geometry() %>% 
                    dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft))

trainingmodel.m <- 
  trainingmodel %>% 
  mutate(Regression = "BASE", 
    SalePrice.Predict = predict(trainingReg, trainingmodel),
         SalePrice.Error = SalePrice.Predict - sale_price,
         SalePrice.AbsError = abs(SalePrice.Predict - sale_price),
         SalePrice.APE = (abs(SalePrice.Predict - sale_price)) / SalePrice.Predict)

trainingmodel.m %>% 
  st_drop_geometry() %>%
  summarise(MAE = mean(SalePrice.AbsError),
            MAPE = mean(SalePrice.APE)*100) %>%
  kbl(col.name=c('Mean Absolute Error','Mean Absolute Percentage Error')) %>%
  kable_styling( bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 2")  
```

Since a baseline regression model to predict sale prices provides only a partial understanding of property values, as these values are intricately tied to their geographic locations within the city. Properties situated near one another tend to exhibit similar characteristics influenced by neighborhood amenities, socioeconomic conditions, and infrastructure development. To explore this relationship further, the analysis examines the correlation of sale prices among properties in close proximity.

A spatial weight matrix was constructed to relate each sale price to those of its five nearest neighbors. Subsequently, Moran's I was computed under the null hypothesis that sale prices are randomly distributed across the area. The accompanying figure illustrates the frequency distribution of 999 randomly permuted Moran's I values generated through a Monte Carlo simulation. This visualization indicates that the observed Moran's I significantly exceeds all randomly generated values.

This finding validates the presence of spatial autocorrelation, suggesting that the sale prices of properties are not randomly distributed but instead exhibit clustering patterns. Such insights are crucial for understanding how location affects property values and can inform future analyses and decision-making processes regarding urban development and real estate investments. 

```{r morans test, warning = FALSE, message = FALSE}
coords.test <-  st_coordinates(trainingmodel.m) 
neighborList.test <- knn2nb(knearneigh(coords.test, 7))
spatialWeights.test <- nb2listw(neighborList.test, style="W")

moranTest <- moran.mc(trainingmodel.m$SalePrice.Error, 
                      spatialWeights.test, nsim = 999)
```



```{r morans plot, warning = FALSE, message = FALSE}
ggplot(as.data.frame(moranTest$res[c(1:999)]), aes(moranTest$res[c(1:999)])) +
  geom_histogram(binwidth = 0.01, fill = "#48913c") +
  geom_vline(aes(xintercept = moranTest$statistic), colour = "#9586a3" ,size=1) +
  scale_x_continuous(limits = c(-0.5, 0.5)) +
  theme_light() +   
  theme(plot.subtitle = element_text(size = 9,face = "italic"),
      axis.text.x=element_text(size=6),
      axis.text.y=element_text(size=6), 
      axis.title=element_text(size=8),
      plot.title = element_markdown(size = 14, face = "bold", hjust=0)) + 
  labs(title = "<span style = 'color:#9586a3;'>Observed</span> and <span style = 'color:#48913c;'>Permuted</span> Moran's I",
       x = "Moran's I",
       y = "Count")
```

By conducting 100 iterations of cross-validation, the MAE is 95665.4, while the variability stands at 9258.774.

```{r cross validation non spatial, warning = FALSE, message = FALSE}
fitControl = trainControl(method = "cv", number = 100)

cvReg = 
  train(sale_price ~ ., data = st_drop_geometry(studentdata.f) %>% 
                             dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft), method = "lm", trControl = fitControl, na.action = na.pass)

cvReg$resample %>% 
  summarise(MAE = mean(cvReg$resample[,3]),
            sd(cvReg$resample[,3])
) %>%
  kbl(col.name=c('Mean Absolute Error','Standard Deviation of MAE')) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 3")
```

# Adding Census Data and Neighborhood
Consider the sale price might be related tot the spatial distributuion of the houses, Census data is add to the existing model.

```{r census key, include=FALSE, eval=FALSE}
census_api_key("0e028dfcee38f844e89c39d01870f6a964f675a2", overwrite = TRUE, install = TRUE)
```

```{r adding spatial features, warning = FALSE, message = FALSE, results='hide'}
#district = st_read("https://raw.githubusercontent.com/jijinjc/musa-5080-midterm/refs/heads/main/Midterm%20Data/Council_Districts_2024.geojson") %>%
  #st_transform("EPSG:6565")

planningDistrict = st_read("https://opendata.arcgis.com/datasets/0960ea0f38f44146bb562f2b212075aa_0.geojson") %>%
  st_transform("EPSG:6565")

studentdata.sp = st_intersection(studentdata.f, planningDistrict %>% dplyr::select("DIST_NAME"))
#st_intersection(studentdata.f, philly %>% dplyr::select("name")) %>% 
#  rename(tractName = name) %>%
#  st_intersection(studentdata.f, district %>% dplyr::select("DISTRICT")) %>%
  

acs20 = 
  get_acs(geography = "tract", 
          variables = c("B02001_001E", 
            "B02001_002E", 
            "B02001_003E", 
            "B02001_005E", 
            "B03002_012E",
            "B19013_001E"), 
          year=2020, state=42, county=101, 
          geometry=TRUE, output="wide") %>%
  st_transform('EPSG:6565') %>% 
  rename(totPop = B02001_001E, 
         white = B02001_002E,
         black = B02001_003E,
         asian = B02001_005E,
         hispanic = B03002_012E,
         medHHIncome = B19013_001E) %>% 
  mutate(pctMinority = ifelse(totPop > 0, (black + asian + hispanic ) / totPop, 0), 
         majority = ifelse(pctMinority > 0.5, "minority", "majority"))

joinrace = studentdata.sp %>% 
  st_intersection(acs20 %>% select(pctMinority)) %>% 
  st_drop_geometry() %>% 
  group_by(parcel_number) %>% 
  summarize(
    minority.m = mean(pctMinority))
joinHHinc = studentdata.sp %>%
  st_intersection(acs20 %>% select(medHHIncome)) %>%
  st_drop_geometry() %>%
  group_by(parcel_number) %>%
  summarize(
    medHHInc = medHHIncome
  )

studentdata.sp = studentdata.sp %>% 
  left_join(joinrace, by = "parcel_number") %>%
  left_join(joinHHinc, by = "parcel_number") 
```

```{r split spatial, warning = FALSE, message = FALSE}
modellingdata.sp = studentdata.sp %>%
  filter(toPredict == 'MODELLING') 


challengedata.sp = studentdata.sp %>%
  filter(toPredict == 'CHALLENGE')

set.seed(1111) 
total_features = nrow(modellingdata.sp)
split_index = sample(1:total_features, size = total_features * 0.6)


trainingmodel.sp = modellingdata.sp[split_index, ] 
testingmodel.sp = modellingdata.sp[-split_index, ]

#testingmodel.sp = modellingdata.sp[-split_index, ] %>%
  #select(-sale_price)
```

A new regression model with the Census indicators is listed below. All indicators show We built a new regression of the model with these indicators and obtained the following results. All indicators show statistically significant correlations with house sale prices at the 95% level, except for the presence of a basement and the distance to the nearest hospital. Adjusted R-squared is 0.507, indicating that the model can explain 50.7% of variations in sale price. 

```{r spatial table, warning = FALSE, message = FALSE}
reg2 <- lm(sale_price ~ ., data = studentdata.sp %>% st_drop_geometry() %>% 
                                 dplyr::select(sale_price, age, totRooms, incBasements, incAC, buildingQuality, incGarage, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft, minority.m, medHHInc, DIST_NAME))
summary_reg2 <- summary(reg2)
coefficients_table <- as.data.frame(summary_reg2$coefficients)


coefficients_table$significance <- ifelse(coefficients_table$`Pr(>|t|)` < 0.001, '***',
                                         ifelse(coefficients_table$`Pr(>|t|)` < 0.01, '**',
                                                ifelse(coefficients_table$`Pr(>|t|)` < 0.05, '*',
                                                       ifelse(coefficients_table$`Pr(>|t|)` < 0.1, '.', ''))))

coefficients_table$p_value <- paste0(round(coefficients_table$`Pr(>|t|)`, digits = 3), coefficients_table$significance)

coefficients_table %>%
  select(-significance, -`Pr(>|t|)`) %>% 
  kable(align = "r") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 4")
```

```{r rval table, warning = FALSE, message = FALSE}
reg2.sumtable <- data.frame(
  Statistic = c("Multiple R-squared", "Adjusted R-squared", "F-statistic"),
  Value = c(
    summary_reg2$r.squared,
    summary_reg2$adj.r.squared,
    summary_reg2$fstatistic[1]
  )
)

reg2.sumtable %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))%>%
  footnote(general_title = "\n", general = "Table 5")
```

Then apply the Mean Absolute Error (MAE) and Mean Absolute Percentage Error (MAPE) for the testing set. Resulting in the MAE is 74013.52, while the MAPE stands at 34.19%.

```{r MAE/MAPE of training model for spatial, warning = FALSE, message = FALSE}
trainingReg.sp <- lm(sale_price ~ ., na.action = na.omit, data = trainingmodel.sp %>% 
                      st_drop_geometry() %>% 
                    dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft, minority.m, medHHInc, DIST_NAME))

testingmodel.sp.m = 
  testingmodel.sp %>% 
  mutate(Regression = "TRACT-NEIGHBORHOOD", 
    SalePrice.Predict = predict(trainingReg.sp, testingmodel.sp),
         SalePrice.Error = SalePrice.Predict - sale_price,
         SalePrice.AbsError = abs(SalePrice.Predict - sale_price),
         SalePrice.APE = (abs(SalePrice.Predict - sale_price)) / SalePrice.Predict)

testingmodel.sp.m %>% 
  st_drop_geometry() %>%
  summarise(MAE = mean(SalePrice.AbsError, na.rm=TRUE),
            MAPE = mean(SalePrice.APE, na.rm=TRUE)*100) %>%
  kbl(col.name=c('Mean Absolute Error','Mean Absolute Percentage Error')) %>%
  kable_styling( bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 6") 

```

```{r morans i spatial, warning = FALSE, message = FALSE}
testing.coords <-  st_coordinates(testingmodel.sp.m) 
testing.tracts <- knn2nb(knearneigh(testing.coords, 5))
spatialWeights.test_n <- nb2listw(testing.tracts, style="W")

moranTest_n <- moran.mc(na.exclude(testingmodel.sp.m$SalePrice.Error), spatialWeights.test_n, nsim = 999)

ggplot(as.data.frame(moranTest_n$res[c(1:999)]), aes(moranTest_n$res[c(1:999)])) +
  geom_histogram(binwidth = 0.01, fill = "#48913c") +
  geom_vline(aes(xintercept = moranTest_n$statistic), colour = "#9586a3" ,size=1) +
  scale_x_continuous(limits = c(-0.5, 0.5)) +
  theme_light() +   
  theme(plot.subtitle = element_text(size = 9,face = "italic"),
      axis.text.x=element_text(size=6),
      axis.text.y=element_text(size=6), 
      axis.title=element_text(size=8),
      plot.title = element_markdown(size = 14, face = "bold", hjust=0)) + 
  labs(title = "<span style = 'color:#9586a3;'>Observed</span> and <span style = 'color:#48913c;'>Permuted</span> Moran's I",
       x = "Moran's I",
       y = "Count")

```

The predicted prices as a function of observed sale prices is then plotted below. The turquoise line represents a would-be perfect fit, while the dark green line represents the predicted fit. It is demonstrate that with the addition of the Census data, the model does a pretty satisfying job at predicting the sale price, perhaps by explaining part of the spatial process and local amenities.

```{r price func of observed price, warning = FALSE, message = FALSE}
testingmodel.sp.m %>%
  dplyr::select(SalePrice.Predict, sale_price) %>%
  ggplot(aes(sale_price, SalePrice.Predict)) +
  geom_point(color = "#9586a3", size = 0.3) +
  stat_smooth(aes(sale_price, sale_price), 
             method = "lm", se = FALSE, size = 1, colour="#006d2c") + 
  stat_smooth(aes(SalePrice.Predict, sale_price), 
              method = "lm", se = FALSE, size = 1, colour="darkturquoise") +
    theme_light() +   
  theme(plot.subtitle = element_markdown(size = 9, face = "italic", hjust=0),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=6),
        axis.text.y=element_text(size=6), 
        axis.title=element_text(size=8)) +
  labs(title="Predicted Sale Price as a Function of Observed Price",
       subtitle="<span style = 'color:darkturquoise;'>100% Accurate Prediction</span> vs <span style = 'color:#006d2c;'>Our Prediction</span>",
       x = "Sale Price",
       y = "Predict Price")
```

```{r sale price error map, warning = FALSE, message = FALSE}
saleError.T = testingmodel.sp.m %>%
  mutate(SalePrice.Error.Cat = cut(SalePrice.Error, 
                                   breaks = c(-Inf, -75000, -1000, 1000, 75000, Inf), 
                                   labels = c("< -75000", "-75000 - -1000", "-1000 - 1000", "1000 - 75000", "75000 <")))

ggplot()+
  geom_sf(data=philly,fill='grey',color='black')+
  geom_sf(data=saleError.T %>% filter(!is.na(SalePrice.Error)), aes(colour = SalePrice.Error.Cat),size=0.5)+
  scale_color_manual(values = c("< -75000" = "#d7191c",
                                "-75000 - -1000" = "#fdae61",
                                "-1000 - 1000" = "#ffffbf",
                                "1000 - 75000" = "#abdda4",
                                "75000 <" = "#2b83ba"), name = "Sale Price Error") +
  theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        ) +
  labs(title = "Sale Price Error of Testing Set") 
```

```{r sale and lag price, warning = FALSE, message = FALSE}
#testingmodel.sp.m <- testingmodel.sp.m[is.finite(testingmodel.sp.m$SalePrice.Error), ]
testingmodel.sp.m$SalePrice.Error[!is.finite(testingmodel.sp.m$SalePrice.Error)] = mean(testingmodel.sp.m$SalePrice.Error, na.rm = TRUE)

testingmodel.sp.m %>% 
  mutate(lagPriceError = lag.listw(spatialWeights.test_n, SalePrice.Error)) %>%
  ggplot()+
  geom_point(aes(x =lagPriceError, y =SalePrice.Error), color = "#9586a3", size = 0.3)+
  stat_smooth(aes(lagPriceError, SalePrice.Error), 
             method = "lm", se = FALSE, size = 1, colour="#006d2c")  +
  labs(title="Sale Price Error as a Function of Lag Price Error",
       x = "Lag Price Error",
       y = "Sale Price Error") +
theme_light() +   
theme(plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=6),
        axis.text.y=element_text(size=6), 
        axis.title=element_text(size=8))
```

```{r cross validation for spatial, warning = FALSE, message = FALSE}
fitControl <- trainControl(method = "cv", number = 100)
set.seed(1111)

cvReg.sp <- 
  train(sale_price ~ ., data = st_drop_geometry(studentdata.sp) %>% 
                             dplyr::select(sale_price, age, totRooms, incBasements, incAC, incGarage, buildingQuality, stories, maxArea, farmersmarket.d.ft, schools.c, hospital.d.ft, bikestations.c, parks.d.ft, minority.m, medHHInc, DIST_NAME), method = "lm", trControl = fitControl, na.action = na.pass)

cvReg.sp$resample %>% 
  summarise(MAE = mean(cvReg.sp$resample[,3]),
            sd(cvReg.sp$resample[,3])
) %>%
  kbl(col.name=c('Mean Absolute Error','Standard Deviation of MAE')) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 7")
```

```{r distribution of MAE histogram, warning = FALSE, message = FALSE}
cvReg.sp$resample %>% 
ggplot(aes(x=cvReg.sp$resample[,3])) +
    geom_histogram( fill="#006d2c", color="#e9ecef") + 
    labs(title="Distribution of Mean Absolute Error for Overall Prediction",
       x = "Mean Absolute Error",
       y = "Count") +
theme_light() +   
theme(plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=6),
        axis.text.y=element_text(size=6), 
        axis.title=element_text(size=8))
```

In the end, our model predicted sale prices according to the map below in Philadelphia. We can see that in general, many of the price predictions are clustered, with each clusters likely having a few sale prices that are different with its surrounding sales.

```{r all value prediction, warning = FALSE, message = FALSE}
finalPrediction <- studentdata.sp %>% 
  mutate(prediction = predict(trainingReg.sp, studentdata.sp)) %>%
  mutate(prediction_class = cut(prediction, breaks = c(0, 250000, 500000, 750000, 1000000, max(prediction, na.rm=TRUE))))

ggplot()+
    geom_sf(data=philly, fill='grey90',color='black')+
    geom_sf(data= finalPrediction %>% filter(!is.na(prediction_class)), size=0.75, aes(colour = q5(prediction_class)))+
    scale_color_manual(values = c("#ffffcc", "#c2e699", "#78c679", "#31a354", "#006837"),
                     name = "Sales Price",
                     labels = c('< 250k', '250k-500k', '500k-750k', '750k-1m', '1m +')) +
   theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        ) +
  labs(title = "Distribution of Predicted Sale Price in Philadelphia") 
```

Looking at the mean absolute percentage error of the tracts in Philadelphia, we actually see that a majority of the tracts and neighborhoods that we looked at fall around a 0.25 MAPE, showing that in general the error of prediction in those areas are not exceptionally high. There is, however, a few tracts within the region that we found there to be high MAPE, indicating that while the accuracy of the model is relatively consistent across a majority of the region, there are still several regions that it is unable to produce an especially accurate prediction.

```{r MAPE map, warning = FALSE, message = FALSE}
mapePlot = st_intersection(testingmodel.sp.m, philly %>% select(name)) %>% 
  st_drop_geometry() %>% 
  group_by(name) %>%
  summarise(mean.MAPE = mean(SalePrice.APE, na.rm = T)) %>% 
  left_join(philly) %>% 
 # mutate(mapeCat = cut(mean.MAPE,breaks = c(-Inf, -1, -0.25, 0.25, 1, Inf), labels = c("< -1", "-1 - -0.25", "-0.25 - 0.25", "0.25 - 1", "1 <"))) %>%
  st_sf() 

mapePlot %>% 
  ggplot() + 
      #geom_sf(aes(fill = mapeCat)) + 
      geom_sf(aes(fill = mean.MAPE)) +
      #scale_fill_manual(values = c("< -1" = "#7b3294","-1 - -0.25" = "#c2a5cf","-0.25 - 0.25" = "#f7f7f7","0.25 - 1" = "#a6dba0","1 <" = "#008837"), name = "MAPE") +
      scale_fill_continuous(low = "white", high = "#008837", name= "MAPE") + 
      theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.title = element_text(size = 12, face = "bold"),
        panel.background = element_blank(),
        panel.border = element_rect(colour = "grey", fill=NA, size=0.4)
        ) +
  labs(title = "Mean Absolute Percentage Error By Census Tract") 
```

The scatterplot below also takes a look at sale price and mape of the neighbourhoods. In general, there is a bigger cluster when the MAPE values are lower than 0.4. These MAPE values are observed regardless of sale price, which may mean that the model has a relatively consistent prediction. However,we also see that the MAPE values that are relatively high tend to also occur when their respective sale price is relatively lower, possibly representing that the neighborhoods with less expensive homes are more difficult to predict with our model. Overall, the model is generally quite accurate for those homes that are moderately priced.

```{r scatterplot mape neighborhood, echo=FALSE, warning=FALSE, message=FALSE}
testingmodel.phl <- st_join(testingmodel.sp.m, philly %>% select(name)) %>% 
  group_by(name) %>%
  summarise(mean.MAPE = mean(SalePrice.APE, na.rm = T)) %>% 
  mutate(st_join(testingmodel.sp.m, philly %>% select(name)) %>% group_by(name) %>%
  summarise(mean.Price = mean(sale_price, na.rm = T)))

testingmodel.phl %>%
  ggplot(aes(mean.MAPE,mean.Price)) +
  geom_point(color = "#9586a3", size = 1 ) +
    labs(title="Sale Price as a Function of MAPE by Neighborhood",
       x = "MAPE",
       y = "Sale Price") +
  theme_light() +   
  theme(plot.subtitle = element_text(size = 9,face = "italic"),
        plot.title = element_text(size = 12, face = "bold"), 
        axis.text.x=element_text(size=6),
        axis.text.y=element_text(size=6), 
        axis.title=element_text(size=8))
```

Finally, for a generalization check, we are looking at the social minority and majority in Philadelphia. Despite the fact that the model yields a 26% for social majority tracts and 4% for social minority tracts, the model is unfortunately unable to provide highly general results for neither social majority nor minority tracts.

```{r generalization, warning = FALSE, message = FALSE}
ggplot() + geom_sf(data = na.omit(acs20), aes(fill = majority), color = NA) +
    scale_fill_manual(values = c("#7fbf7b", "#9586a3")) +
    geom_sf(data=philly, fill='transparent',color='black') +
    guides(fill = "none")+
    theme(
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        plot.title = element_markdown(size = 14, face = "bold", hjust=0),
        panel.background = element_blank(),
        plot.legend = element_blank()
        ) +
    labs(title = "Social <span style = 'color:#7fbf7b;'>Majority</span> vs <span style = 'color:#9586a3;'>Minority</span> in Philadelphia")
```

```{r social mape, warning = FALSE, message = FALSE}
st_join(testingmodel.sp.m, acs20) %>% 
  filter(!is.na(majority)) %>%
  group_by(majority) %>%
  summarize(mean.MAPE = scales::percent(mean(SalePrice.APE, na.rm = T))) %>%
  st_drop_geometry() %>%
  spread(majority, mean.MAPE) %>%
  kbl(col.name=c('Majority Tracts','Minority Tracts')) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  footnote(general_title = "\n", general = "Table 8")
```

#Discussion 
This model effectively predicts most housing prices, although a few exceptionsâ€”likely attributable to extreme values and the inherent randomness within the dataâ€”are noted.

The analysis explored various variables to understand the spatial correlations between local amenities and housing prices, particularly the distance to nearby schools. The model identified that property size significantly influences sale prices, as illustrated in the data section, where the maximum area shows the highest positive correlation with sale price among all factors. This finding aligns with common trends observed in urban real estate markets, indicating that property size is a dominant factor affecting housing prices.

Overall, the predictors in the model account for approximately 50% of the variations in housing prices, with R-squared values hovering around 0.5. Furthermore, the spatial clustering of high-priced homes within the city center is evident, indicating that desirable locations contribute to increased property values.

One notable observation is the existence of a housing unit with an age exceeding 500 years, which may be viewed as either a failure of model fitting or an extreme value in the dataset. Both the baseline regression and neighborhood effects models exhibit a relatively high Mean Absolute Percentage Error (MAPE) of about 39%, prompting the removal of outlier data to enhance prediction accuracy.

It is important to highlight that this model pays relatively less attention to safety factors, such as crime rates. This oversight could diminish the model's generalizability, as local crime rates are significant determinants influencing potential buyers' willingness to purchase properties, particularly for families with children. Future iterations of the model should consider incorporating safety indicators to provide a more comprehensive understanding of the factors affecting housing prices in Philadelphia.

#Conclusion 
In summary, this model is effectively predicting the Philadelphia housing price in a certain context. leveraging a comprehensive dataset that includes various local amenities and property characteristics. The analysis highlighted the significant impact of property size on sale prices, reaffirming the common understanding that larger homes typically command higher market values. The model's ability to account for approximately 50% of the variance in housing prices indicates a understanding of the key factors (the housing internal charateristcs, spatial location and certain nearby facilities) influencing the market.

However, certain limitations were identified, including the presence of outliers, such as properties with extreme ages, which can skew predictions and affect overall accuracy. The model's performance is also characterized by a relatively high Mean Absolute Percentage Error, suggesting that while it performs well, there is still room for improvement in its predictive capabilities. Furthermore, the omission of safety factors, such as crime rates, may limit the model's generalizability and applicability, particularly for families who prioritize neighborhood safety when considering property purchases.
